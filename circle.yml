machine:
  hosts:
    breezy.prod: 78.46.62.19
  java:
    version: oraclejdk8
  services:
   - docker

dependencies:
  override:
    - docker info
    - docker pull java:openjdk-8
    - docker pull traefik

#test:
#  override:
#    - ./gradlew test
#  post:
#    - mkdir -p $CIRCLE_TEST_REPORTS/reports/
#    - find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/reports/ \;

deployment:
  production:
    branch: master
    commands:
      - cd web-server
      - ./sbt universal:package-bin
      - docker build --rm=false -f Dockerfile -t breezy16/web-server .
      - cd ../traefik
      - docker build --rm=false -f Dockerfile -t breezy16/traefik .
      - docker login -u $DOCKER_USER -p $DOCKER_PASS
      - docker push breezy16/web-server
      - docker push breezy16/traefik
      - cd ..
      # copy entire compose to server and restart containers
      - scp docker-compose.yml circleci@breezy.prod:/breezy/docker-compose.yml
      - scp docker-compose.production.yml circleci@breezy.prod:/breezy/docker-compose.production.yml
      - >
          ssh circleci@breezy.prod 'docker login -u $DOCKER_USER -p $DOCKER_PASS
                 && cd /breezy
                 && docker-compose -f docker-compose.yml -f docker-compose.production.yml up -d '